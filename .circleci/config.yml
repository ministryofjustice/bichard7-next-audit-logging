version: 2.1

jobs:
  build:
    docker:
      - image: cimg/node:15.9.0
    working_directory: ~
    steps:
      - checkout

      # Load dependencies from the cache if they exist and haven't changed
      - restore_cache:
          keys:
            - v1-npm-deps-{{ checksum "package-lock.json" }}
            - v1-npm-deps-{{ checksum "shared/package-lock.json" }}
            - v1-npm-deps-{{ checksum "incoming-message-handler/package-lock.json" }}
            - v1-npm-deps-{{ checksum "audit-log-api/package-lock.json" }}
            - v1-npm-deps-{{ checksum "audit-log-portal/package-lock.json" }}

      - run: ./scripts/install-all.sh
      - run: ./scripts/build-all.sh
      - run: npm run lint

      # Update the cache with the latest installed dependencies to speed up future installs
      - save_cache:
          key: v1-npm-deps-{{ checksum "package-lock.json" }}
          paths: node_modules

      - save_cache:
          key: v1-npm-deps-{{ checksum "shared/package-lock.json" }}
          paths: shared/node_modules

      - save_cache:
          key: v1-npm-deps-{{ checksum "incoming-message-handler/package-lock.json" }}
          paths: incoming-message-handler/node_modules

      - save_cache:
          key: v1-npm-deps-{{ checksum "audit-log-api/package-lock.json" }}
          paths: audit-log-api/node_modules

      - save_cache:
          key: v1-npm-deps-{{ checksum "audit-log-portal/package-lock.json" }}
          paths: audit-log-portal/node_modules

      # Persist all dist/build folders to the workspace to reduce build time later
      - persist_to_workspace:
          root: .
          paths:
            - shared/dist
            - incoming-message-handler/build
            - audit-log-api/build
            - audit-log-portal/.next

  test:
    docker:
      - image: cimg/node:15.9.0
    working_directory: ~
    steps:
      - checkout

      # Restore any cached dependencies for the projects to reduce install time
      - restore_cache:
          key: v1-npm-deps-{{ checksum "package-lock.json" }}

      - restore_cache:
          key: v1-npm-deps-{{ checksum "shared/package-lock.json" }}

      - restore_cache:
          key: v1-npm-deps-{{ checksum "incoming-message-handler/package-lock.json" }}

      - restore_cache:
          key: v1-npm-deps-{{ checksum "audit-log-api/package-lock.json" }}

      - restore_cache:
          key: v1-npm-deps-{{ checksum "audit-log-portal/package-lock.json" }}

      - run: ./scripts/install-all.sh

      # Attach the workspace to retrieve the dist/build folders so we don't have to rebuild
      - attach_workspace:
          at: .

      - run: ./scripts/test-all.sh

      - store_test_results:
          path: ./shared/test-results/jest/
      - store_test_results:
          path: ./incoming-message-handler/test-results/jest/
      - store_test_results:
          path: ./audit-log-api/test-results/jest/
      - store_test_results:
          path: ./audit-log-portal/test-results/jest/

workflows:
  version: 2
  build-and-test:
    jobs:
      - build
      - test:
          requires:
            - build
